<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPT-III Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        .target {
            font-size: 40px;
            margin: 50px;
            display: none;
        }
        button {
            margin-top: 20px;
        }
        .seed-input {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>CPT-III Simulation 3</h1>
    <p>Press the "SPACE" key when you see letters other than "X".</p>

    <div class="seed-input">
        <label for="seedInput">Seed (for repeatable test): </label>
        <input type="number" id="seedInput" placeholder="Enter seed">
    </div>

    <div id="target" class="target">A</div>

    <button id="startButton">Start Test</button>
    <div id="result"></div>

    <script>
        let letters = ["A", "B", "X", "C", "D"];
        let intervals = [1000, 2000, 4000]; // 1s, 2s, 4s intervals
        let correctResponses = 0;
        let totalResponses = 0;
        let omissions = 0;
        let commissions = 0;
        let perseverations = 0;
        let reactionTimes = [];
        let isiChanges = [];
        let blockReactionTimes = [];
        let blockInterval = 30000; // 30 seconds per block
        let testDuration = 120000; // 2 minutes
        let interval;
        let isTestRunning = false;
        let stimulusStartTime;
        let previousInterval;
        let blockTimer;
        let rng;

        const target = document.getElementById("target");
        const startButton = document.getElementById("startButton");
        const result = document.getElementById("result");
        const seedInput = document.getElementById("seedInput");

        function seededRandom(seed) {
            let x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        function initializeRNG(seed) {
            return function () {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            };
        }

        function startTest() {
            const seed = seedInput.value ? parseInt(seedInput.value, 10) : Date.now();
            rng = initializeRNG(seed);
            correctResponses = 0;
            totalResponses = 0;
            omissions = 0;
            commissions = 0;
            perseverations = 0;
            reactionTimes = [];
            isiChanges = [];
            blockReactionTimes = [];
            result.textContent = "";
            isTestRunning = true;
            startButton.disabled = true;

            blockTimer = setInterval(recordBlockReactionTime, blockInterval);

            function showStimulus() {
                const randomLetter = letters[Math.floor(rng() * letters.length)];
                const currentInterval = intervals[Math.floor(rng() * intervals.length)];

                if (previousInterval !== undefined) {
                    isiChanges.push(Math.abs(currentInterval - previousInterval));
                }
                previousInterval = currentInterval;

                target.textContent = randomLetter;
                target.style.display = "block";
                stimulusStartTime = performance.now();

                setTimeout(() => {
                    if (target.textContent !== "X" && target.style.display === "block") {
                        omissions++;
                    }
                    target.style.display = "none";
                    if (isTestRunning) {
                        setTimeout(showStimulus, currentInterval);
                    }
                }, 800); // Show letter for 800ms
            }

            showStimulus();
            setTimeout(endTest, testDuration);
        }

        function recordBlockReactionTime() {
            if (reactionTimes.length > 0) {
                const blockAverage = reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length;
                blockReactionTimes.push(blockAverage);
                reactionTimes = []; // Reset for the next block
            }
        }

        function endTest() {
            isTestRunning = false;
            target.style.display = "none";
            startButton.disabled = false;
            clearInterval(blockTimer);

            if (reactionTimes.length > 0) {
                recordBlockReactionTime(); // Record the last block if not yet recorded
            }

            let blockChanges = [];
            for (let i = 1; i < blockReactionTimes.length; i++) {
                blockChanges.push(Math.abs(blockReactionTimes[i] - blockReactionTimes[i - 1]));
            }
            const hrtBlockChange = blockChanges.length > 0 ? (blockChanges.reduce((a, b) => a + b, 0) / blockChanges.length).toFixed(2) : "N/A";

            const hrt = blockReactionTimes.length > 0 ? (blockReactionTimes.reduce((a, b) => a + b, 0) / blockReactionTimes.length).toFixed(2) : "N/A";
            const hrtSd = blockReactionTimes.length > 1 ? Math.sqrt(blockReactionTimes.map(rt => Math.pow(rt - hrt, 2)).reduce((a, b) => a + b, 0) / (blockReactionTimes.length - 1)).toFixed(2) : "N/A";
            const variability = hrtSd;
            const isiChange = isiChanges.length > 0 ? (isiChanges.reduce((a, b) => a + b, 0) / isiChanges.length).toFixed(2) : "N/A";
            const dPrime = (correctResponses - commissions).toFixed(2);

            result.innerHTML = `
                <h2>Test Results</h2>
                <p>Total Responses: ${totalResponses}</p>
                <p>Correct Responses: ${correctResponses}</p>
                <p>Omissions: ${omissions}</p>
                <p>Commissions: ${commissions}</p>
                <p>Perseverations: ${perseverations}</p>
                <p>Hit Reaction Time (HRT): ${hrt} ms</p>
                <p>HRT Standard Deviation (SD): ${hrtSd}</p>
                <p>Variability: ${variability}</p>
                <p>HRT Block Change: ${hrtBlockChange} ms</p>
                <p>HRT Inter-Stimulus Interval (ISI) Change: ${isiChange} ms</p>
                <p>Detectability (d'): ${dPrime}</p>
                <p>Seed Used: ${seed}</p>
            `;

            // Prevent restarting until the user clicks the button
            startButton.disabled = false;
        }

        document.addEventListener("keydown", (event) => {
            if (!isTestRunning) return;

            if (event.code === "Space") {
                totalResponses++;
                if (target.textContent !== "X" && target.style.display === "block") {
                    correctResponses++;
                    const reactionTime = performance.now() - stimulusStartTime;
                    reactionTimes.push(reactionTime);
                } else if (target.style.display === "block") {
                    commissions++;
                } else {
                    perseverations++;
                }
            }
        });

        startButton.addEventListener("click", startTest);
    </script>
</body>
</html>
