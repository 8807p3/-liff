<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPT-2025 測驗模擬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        .target {
            font-size: 40px;
            margin: 50px;
            display: none;
        }
        button {
            margin-top: 20px;
        }
        .seed-input {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>CPT-III 測驗模擬202501</h1>
    <p>請在看到非「X」的字母時按下「空白鍵」。</p>

    <div class="seed-input">
        <label for="seedInput">測試種子（可重複測驗用）: </label>
        <input type="number" id="seedInput" placeholder="請輸入種子數值">
    </div>

    <div id="prompt" class="target" style="display: none;">準備開始...</div>
    <div id="target" class="target"></div>

    <button id="startButton">開始測試</button>
    <div id="result"></div>

<script>
    // 全域變數
    let seed;
    let letters = ["A", "B", "X", "C", "D"];
    let intervals = [1000, 2000, 4000]; // 1s, 2s, 4s intervals
    let correctResponses = 0;
    let totalResponses = 0;
    let omissions = 0;
    let commissions = 0;
    let perseverations = 0;
    let reactionTimes = [];
    let isiReactionTimes = { 1000: [], 2000: [], 4000: [] }; // 每個 ISI 的反應時間
    let isiChanges = [];
    let blockReactionTimes = [];
    let blockOmissions = [];
    let blockCommissions = [];
    let blockInterval = 30000; // 30 seconds per block
    let testDuration = 120000; // 2 minutes
    let isTestRunning = false;
    let stimulusStartTime;
    let currentInterval;
    let previousInterval;
    let blockTimer;
    let rng;

    const prompt = document.getElementById("prompt");
    const target = document.getElementById("target");
    const startButton = document.getElementById("startButton");
    const result = document.getElementById("result");
    const seedInput = document.getElementById("seedInput");

    function seededRandom(seed) {
        let x = Math.sin(seed) * 10000;
        return x - Math.floor(x);
    }

    function initializeRNG(seed) {
        return function () {
            seed = (seed * 9301 + 49297) % 233280;
            return seed / 233280;
        };
    }

    function startTest() {
        // 初始化全域變數
        seed = seedInput.value ? parseInt(seedInput.value, 10) : Date.now();
        rng = initializeRNG(seed);
        correctResponses = 0;
        totalResponses = 0;
        omissions = 0;
        commissions = 0;
        perseverations = 0;
        reactionTimes = [];
        isiReactionTimes = { 1000: [], 2000: [], 4000: [] };
        isiChanges = [];
        blockReactionTimes = [];
        blockOmissions = [];
        blockCommissions = [];
        result.innerHTML = "";
        isTestRunning = true;
        startButton.disabled = true;

        prompt.style.display = "block";
        target.style.display = "none";
        prompt.textContent = "準備開始...";
        
        setTimeout(() => {
            prompt.style.display = "none";
            runTest();
        }, 3000); // 等待 3 秒
    }

    function runTest() {
        blockTimer = setInterval(recordBlockMetrics, blockInterval);

        function showStimulus() {
            const randomLetter = letters[Math.floor(rng() * letters.length)];
            currentInterval = intervals[Math.floor(rng() * intervals.length)];

            if (previousInterval !== undefined) {
                isiChanges.push(Math.abs(currentInterval - previousInterval));
            }
            previousInterval = currentInterval;

            target.textContent = randomLetter;
            target.style.display = "block";
            stimulusStartTime = performance.now();

            setTimeout(() => {
                if (target.textContent !== "X" && target.style.display === "block") {
                    omissions++;
                }
                target.style.display = "none";
                if (isTestRunning) {
                    setTimeout(showStimulus, currentInterval);
                }
            }, 800); // 顯示字母 800ms
        }

        showStimulus();
        setTimeout(endTest, testDuration);
    }

    function recordBlockMetrics() {
        if (reactionTimes.length > 0) {
            const blockAverage = reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length;
            blockReactionTimes.push(blockAverage);
            blockOmissions.push(omissions);
            blockCommissions.push(commissions);

            // 清空區塊資料以記錄下一區塊
            reactionTimes = [];
            omissions = 0;
            commissions = 0;
        }
    }

    function endTest() {
        isTestRunning = false;
        target.style.display = "none";
        startButton.disabled = false;
        clearInterval(blockTimer);

        if (reactionTimes.length > 0) {
            recordBlockMetrics(); // 紀錄最後一個區塊
        }

        let isiAverageReactionTimes = {};
        for (let isi in isiReactionTimes) {
            if (isiReactionTimes[isi].length > 0) {
                isiAverageReactionTimes[isi] = (
                    isiReactionTimes[isi].reduce((a, b) => a + b, 0) /
                    isiReactionTimes[isi].length
                ).toFixed(2);
            } else {
                isiAverageReactionTimes[isi] = "N/A";
            }
        }

        const hrt = blockReactionTimes.length > 0
            ? (blockReactionTimes.reduce((a, b) => a + b, 0) / blockReactionTimes.length).toFixed(2)
            : "N/A";

        result.innerHTML = `
            <h2>測試結果</h2>
            <p>總反應次數: ${totalResponses}</p>
            <p>正確反應次數: ${correctResponses}</p>
            <p>遺漏次數: ${omissions}</p>
            <p>誤反應次數: ${commissions}</p>
            <p>每區塊的平均反應時間: ${blockReactionTimes.map((rt, i) => `<br>區塊${i + 1}: ${rt.toFixed(2)} 毫秒`).join("")}</p>
            <p>每區塊的遺漏次數: ${blockOmissions.map((om, i) => `<br>區塊${i + 1}: ${om}`).join("")}</p>
            <p>每區塊的誤反應次數: ${blockCommissions.map((com, i) => `<br>區塊${i + 1}: ${com}`).join("")}</p>
            <p>每個 ISI 的平均反應時間: ${Object.entries(isiAverageReactionTimes).map(([isi, avg]) => `<br>${isi} 毫秒間隔: ${avg}`).join("")}</p>
            <p>測試種子: ${seed}</p>
        `;
    }

    document.addEventListener("keydown", (event) => {
        if (!isTestRunning) return;

        if (event.code === "Space") {
            totalResponses++;
            if (target.textContent !== "X" && target.style.display === "block") {
                correctResponses++;
                const reactionTime = performance.now() - stimulusStartTime;
                reactionTimes.push(reactionTime);

                if (isiReactionTimes[currentInterval]) {
                    isiReactionTimes[currentInterval].push(reactionTime);
                }
            } else if (target.style.display === "block") {
                commissions++;
            } else {
                perseverations++;
            }
        }
    });

    startButton.addEventListener("click", startTest);
</script>


</body>
</html>
