<!DOCTYPE html>
<html>
<!-- head 和 style 部分保持不變 -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>活動列表</title>
    <style>
        /* 原有的 CSS 保持不變 */
    </style>
</head>
<body>
    <div class="container">
        <h1>活動列表（今日及未來）</h1>
        <div id="loading">載入中...</div>
        <div id="error" class="error"></div>
        <div id="data-container"></div>
    </div>

    <script>
        const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwL5_CNpbaiNpEPrjrz9xpGKldMuOe54WOPJU6UEed2uuOHyTNPTalUWE03ebUh15-S/exec';

        function loadData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            loading.style.display = 'block';
            error.style.display = 'none';

            fetch(GAS_WEBAPP_URL)
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    renderTable(data);
                })
                .catch(err => {
                    loading.style.display = 'none';
                    error.textContent = '載入失敗：' + err.message;
                    error.style.display = 'block';
                    console.error('Error:', err);
                });
        }

        function renderTable(data) {
            var tableHtml = '<table><thead><tr><th>日期</th><th>時間</th><th>主題</th><th>備註</th></tr></thead><tbody>';

            for (var i = 1; i < data.length; i++) {
                var row = data[i];
                var originalRow = row[row.length - 1];
                tableHtml += '<tr>';
                tableHtml += '<td data-label="日期">' + formatDate(row[0]) + '</td>';
                tableHtml += '<td data-label="時間">' + row[1] + ' - ' + row[2] + '</td>';
                tableHtml += '<td data-label="主題">' + row[3] + '</td>';
                var noteText = row[4] || '點擊添加備註';
                var noteClass = row[4] ? 'edit-note' : 'edit-note empty-note';
                tableHtml += '<td data-label="備註"><span class="' + noteClass + '" onclick="editNote(' + originalRow + ', this)">' + noteText + '</span></td>';
                tableHtml += '</tr>';
            }

            tableHtml += '</tbody></table>';
            document.getElementById('data-container').innerHTML = tableHtml;
        }

        function formatDate(dateNum) {
            var dateStr = dateNum.toString().padStart(4, '0');
            var month = dateStr.substring(0, 2);
            var day = dateStr.substring(2);
            return month + '/' + day;
        }

        function editNote(originalRow, element) {
            var currentNote = element.textContent;
            if (currentNote === '點擊添加備註') {
                currentNote = '';
            }
            var newNote = prompt("編輯備註:", currentNote);

            if (newNote !== null && newNote !== currentNote) {
                // 使用 GET 請求來更新備註
                const updateUrl = `${GAS_WEBAPP_URL}?action=updateNote&row=${originalRow}&note=${encodeURIComponent(newNote)}`;
                
                fetch(updateUrl)
                    .then(response => response.json())
                    .then(result => {
                        if (result.status === 'success' || result === "備註更新成功") {
                            if (newNote === '') {
                                element.textContent = '點擊添加備註';
                                element.classList.add('empty-note');
                            } else {
                                element.textContent = newNote;
                                element.classList.remove('empty-note');
                            }
                            alert('備註更新成功');
                        } else {
                            throw new Error(result.message || '更新失敗');
                        }
                    })
                    .catch(err => {
                        alert('更新失敗：' + err.message);
                    });
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>
